from flask import Flask, request, jsonify
import requests
import json
import time

app = Flask(__name__)

# ========== Notion é…ç½® ==========
NOTION_API_KEY = "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"
MAPPING_DATABASE_ID = "1a6f3c4a-351e-806a-90cb-e53c17e53f8b"  # è¯·æ›¿æ¢ä¸ºå®é™… Button Mapping æ•°æ®åº“ID
HEADERS = {
    "Authorization": f"Bearer {NOTION_API_KEY}",
    "Content-Type": "application/json",
    "Notion-Version": "2022-06-28"
}

@app.route("/notion-webhook", methods=["POST"])
def notion_webhook():
    """
    Webhook å…¥å£ï¼š
      - ä» Webhook æ•°æ®ä¸­è·å– A é¡µé¢ ID ä»¥åŠ properties
      - è¯»å– Button Mapping æ•°æ®åº“ä¸­çš„æ˜ å°„æ•°æ®ï¼Œæ¯è¡ŒåŒ…å«ï¼š
            * Nameï¼šå…³é”®è¯ï¼ˆå¦‚ "%Fiary", "%Collection"ï¼‰
            * Relationï¼šA é¡µé¢ä¸­ç”¨äºå…³è” B é¡µé¢çš„å±æ€§åç§°ï¼ˆå¦‚ "Fiarybase", "Collection Home"ï¼‰
      - å¯¹äºæ¯ä¸ªæ˜ å°„ï¼Œåªæœ‰å½“ A é¡µé¢çš„ properties ä¸­å­˜åœ¨å¯¹åº” Relation ä¸”å…³è”æ•°æ®ä¸ä¸ºç©ºæ—¶æ‰å¤„ç†ï¼š
            * ä» webhook payload çš„ properties ä¸­è·å– B é¡µé¢ ID åˆ—è¡¨
            * åœ¨ A é¡µé¢ä¸­æŸ¥æ‰¾ marker åçš„åŒæ­¥å—ï¼ˆå¦‚æœå­˜åœ¨åˆ™è¿”å›è¯¥åŒæ­¥å— IDï¼›å¦‚æœ marker å­˜åœ¨ä½†åé¢æ²¡æœ‰åŒæ­¥å—ï¼Œåˆ™å°è¯•åœ¨é¡µé¢åº•éƒ¨åˆ›å»ºæ–°çš„åŒæ­¥å—ï¼›å¦‚æœé¡µé¢ä¸­å®Œå…¨æ²¡æœ‰ markerï¼Œåˆ™è·³è¿‡ï¼‰
            * å°†è¯¥åŒæ­¥å—å¤åˆ¶åˆ°æ‰€æœ‰å¯¹åº”çš„ B é¡µé¢ä¸­
    """
    data = request.json
    print(f"âœ… æ”¶åˆ° Notion Webhook è¯·æ±‚: {json.dumps(data, indent=2)}")

    source_page_id = data.get("data", {}).get("id")
    if not source_page_id:
        return jsonify({"error": "æœªæ‰¾åˆ° A é¡µé¢ ID"}), 400

    # ä» webhook payload ä¸­è·å– A é¡µé¢çš„ properties
    source_props = data.get("data", {}).get("properties", {})

    # è¯»å– Button Mapping æ•°æ®åº“ï¼ˆä½¿ç”¨ API æŸ¥è¯¢ï¼‰
    mapping_rows = get_button_mapping_rows(MAPPING_DATABASE_ID)
    if not mapping_rows:
        return jsonify({"error": "Button Mapping æ•°æ®åº“ä¸ºç©º"}), 400

    for mapping in mapping_rows:
        marker = mapping["Name"]         # å¦‚ "%Fiary" æˆ– "%Collection"
        relation_prop = mapping["Relation"] # å¦‚ "Fiarybase" æˆ– "Collection Home"
        print(f"=== å¤„ç†æ˜ å°„ï¼šå…³é”®è¯: {marker}, Relation: {relation_prop} ===")

        # ä»…ä½¿ç”¨ webhook payload ä¸­çš„æ•°æ®æ¥åˆ¤æ–­æ˜¯å¦è§¦å‘è¯¥æ˜ å°„
        b_page_ids = get_b_pages_from_property_from_webhook(source_props, relation_prop)
        if not b_page_ids:
            print(f"âš ï¸ Webhookä¸­ A é¡µé¢å±æ€§ {relation_prop} æ— å…³è” B é¡µé¢ï¼Œè·³è¿‡")
            continue

        # æŸ¥æ‰¾ A é¡µé¢ä¸­ marker åçš„åŒæ­¥å—
        sync_block_id = find_synced_block_after_marker(source_page_id, marker)
        if sync_block_id == "marker_not_found":
            print(f"âš ï¸ A é¡µé¢ä¸­å®Œå…¨æœªæ‰¾åˆ° marker {marker}ï¼Œè·³è¿‡æ­¤æ˜ å°„")
            continue
        if not sync_block_id:
            print(f"âš ï¸ æ‰¾åˆ° marker {marker} ä½†åé¢æ— åŒæ­¥å—ï¼Œå°è¯•åœ¨é¡µé¢åº•éƒ¨åˆ›å»ºæ–°çš„åŒæ­¥å—...")
            sync_block_id = create_synced_block_at_bottom(source_page_id, marker)
            if not sync_block_id:
                print("âŒ åˆ›å»ºåŒæ­¥å—å¤±è´¥ï¼Œè·³è¿‡æ­¤æ˜ å°„")
                continue

        for b_page_id in b_page_ids:
            print(f"ğŸš€ å°† A é¡µé¢åŒæ­¥å— {sync_block_id} å¤åˆ¶åˆ° B é¡µé¢ {b_page_id}")
            copy_synced_block_content(sync_block_id, b_page_id)

    return jsonify({"status": "success"})

# ========== è¯»å– Button Mapping æ•°æ®åº“ ==========
def get_button_mapping_rows(database_id):
    url = f"https://api.notion.com/v1/databases/{database_id}/query"
    resp = requests.post(url, headers=HEADERS)
    if resp.status_code != 200:
        print(f"âŒ è¯»å– Button Mapping å¤±è´¥: {resp.text}")
        return []
    results = resp.json().get("results", [])
    rows = []
    for row in results:
        props = row.get("properties", {})
        name_val = extract_plain_text(props.get("Name", {}))
        relation_val = extract_plain_text(props.get("Relation", {}))
        if name_val and relation_val:
            rows.append({"Name": name_val, "Relation": relation_val})
    print(f"âœ… è¯»å–åˆ° {len(rows)} è¡Œ Button Mapping æ•°æ®: {rows}")
    return rows

def extract_plain_text(prop):
    ptype = prop.get("type")
    if ptype == "title":
        return "".join(t.get("plain_text", "") for t in prop.get("title", []))
    elif ptype == "rich_text":
        return "".join(t.get("plain_text", "") for t in prop.get("rich_text", []))
    return ""

# ========== ä» webhook payload è·å– B é¡µé¢ ID ==========
def get_b_pages_from_property_from_webhook(source_props, property_name):
    """
    ä» webhook payload ä¸­çš„ A é¡µé¢ properties è·å–æŒ‡å®š Relation çš„ B é¡µé¢ ID åˆ—è¡¨
    """
    if property_name not in source_props:
        print(f"âš ï¸ Webhookä¸­æœªåŒ…å«å±æ€§ {property_name}")
        return []
    rel_prop = source_props[property_name]
    if rel_prop.get("type") != "relation":
        print(f"âš ï¸ Webhookä¸­å±æ€§ {property_name} ä¸æ˜¯ relation ç±»å‹")
        return []
    relation_list = rel_prop.get("relation", [])
    if not relation_list:
        print(f"âš ï¸ Webhookä¸­å±æ€§ {property_name} å…³è”åˆ—è¡¨ä¸ºç©º")
        return []
    b_page_ids = [r["id"] for r in relation_list]
    print(f"âœ… Webhook: A é¡µé¢å±æ€§ {property_name} -> B é¡µé¢åˆ—è¡¨: {b_page_ids}")
    return b_page_ids

# ========== è·å–é¡µé¢ Blocks ==========
def get_page_blocks(page_id):
    url = f"https://api.notion.com/v1/blocks/{page_id}/children"
    resp = requests.get(url, headers=HEADERS)
    if resp.status_code == 200:
        return resp.json().get("results", [])
    print(f"âŒ è·å–é¡µé¢ {page_id} Blocks å¤±è´¥: {resp.text}")
    return []

# ========== æŸ¥æ‰¾åŒæ­¥å— ==========
def find_synced_block_after_marker(page_id, marker):
    """
    åœ¨ A é¡µé¢ä¸­æŸ¥æ‰¾æŒ‡å®š marker åé¢çš„ç¬¬ä¸€ä¸ªåŒæ­¥å—ã€‚
    å¦‚æœé¡µé¢ä¸­å®Œå…¨æ²¡æœ‰ markerï¼Œåˆ™è¿”å› "marker_not_found"ï¼›
    å¦‚æœ marker å­˜åœ¨ä½† marker åæ²¡æœ‰åŒæ­¥å—ï¼Œåˆ™è¿”å› Noneã€‚
    """
    print(f"ğŸ” è·å– A é¡µé¢ {page_id} çš„ Blocks...")
    blocks = get_page_blocks(page_id)
    if not blocks:
        return None
    marker_found = False
    for i, block in enumerate(blocks):
        btype = block.get("type")
        text_content = block.get(btype, {}).get("rich_text", [])
        if text_content and text_content[0].get("text", {}).get("content") == marker:
            marker_found = True
            print(f"âœ… æ‰¾åˆ° marker {marker} in {btype}ï¼Œä½ç½® {i}")
            # æ£€æŸ¥ marker åçš„ç¬¬ä¸€ä¸ª blockæ˜¯å¦ä¸ºåŒæ­¥å—
            if i + 1 < len(blocks):
                next_block = blocks[i+1]
                if next_block.get("type") == "synced_block":
                    print(f"âœ… Marker åçš„ç¬¬ä¸€ä¸ª blockå·²ä¸ºåŒæ­¥å—ï¼ŒID: {next_block.get('id')}")
                    return next_block.get("id")
            return None
    if not marker_found:
        print(f"âš ï¸ æœªæ‰¾åˆ° marker {marker} in A é¡µé¢ {page_id}")
        return "marker_not_found"
    return None

# ========== åˆ›å»ºåŒæ­¥å—ï¼ˆè¿½åŠ åˆ°é¡µé¢åº•éƒ¨ï¼‰ ==========
def create_synced_block_at_bottom(page_id, marker):
    """
    åœ¨ A é¡µé¢åº•éƒ¨åˆ›å»ºæ–°çš„åŒæ­¥å—ï¼ˆè¿½åŠ åˆ°é¡µé¢æœ«å°¾ï¼‰ï¼Œè¿”å›åŒæ­¥å—IDã€‚
    ä»…åœ¨é¡µé¢ä¸­å­˜åœ¨ marker çš„æƒ…å†µä¸‹è°ƒç”¨ã€‚
    """
    new_sync_block = {
        "object": "block",
        "type": "synced_block",
        "synced_block": {"synced_from": None}
    }
    url = f"https://api.notion.com/v1/blocks/{page_id}/children"
    resp = requests.patch(url, headers=HEADERS, json={"children": [new_sync_block]})
    if resp.status_code == 200:
        print(f"âœ… åœ¨ A é¡µé¢åº•éƒ¨æ–°å»ºåŒæ­¥å—æˆåŠŸ")
        time.sleep(1)
        result = find_synced_block_after_marker(page_id, marker)
        if result == "marker_not_found":
            return None
        return result or new_sync_block.get("id")
    else:
        print(f"âŒ åˆ›å»ºåŒæ­¥å—å¤±è´¥: {resp.text}")
        return None

# ========== åŒæ­¥åˆ° B é¡µé¢ ==========
def copy_synced_block_content(sync_block_id, target_page_id):
    """
    å°† A é¡µé¢çš„åŒæ­¥å—å¤åˆ¶åˆ° B é¡µé¢ï¼š
      - è‹¥åŒæ­¥å—å·²åŒæ­¥è‡ªå…¶ä»–å—ï¼Œåˆ™ä½¿ç”¨åŸå§‹å— IDï¼›å¦åˆ™ä½¿ç”¨å½“å‰åŒæ­¥å— IDã€‚
      - åœ¨ B é¡µé¢è¿½åŠ ä¸€ä¸ªæ–°çš„åŒæ­¥å—å¼•ç”¨åŸå§‹å—ã€‚
    """
    detail_url = f"https://api.notion.com/v1/blocks/{sync_block_id}"
    detail_resp = requests.get(detail_url, headers=HEADERS)
    if detail_resp.status_code != 200:
        print(f"âŒ è·å–æºåŒæ­¥å—è¯¦æƒ…å¤±è´¥: {detail_resp.text}")
        return
    source_block = detail_resp.json()
    synced_info = source_block.get("synced_block", {})
    if synced_info.get("synced_from"):
        original_block_id = synced_info["synced_from"].get("block_id")
        print(f"âœ… æºåŒæ­¥å— {sync_block_id} åŒæ­¥è‡ª {original_block_id}")
    else:
        original_block_id = sync_block_id

    new_sync_block = {
        "object": "block",
        "type": "synced_block",
        "synced_block": {"synced_from": {"block_id": original_block_id}}
    }
    add_url = f"https://api.notion.com/v1/blocks/{target_page_id}/children"
    resp = requests.patch(add_url, headers=HEADERS, json={"children": [new_sync_block]})
    if resp.status_code == 200:
        print(f"âœ… æˆåŠŸåŒæ­¥ block åˆ° B é¡µé¢ {target_page_id}")
    else:
        print(f"âŒ åŒæ­¥ block å¤±è´¥: {resp.text}")

# ========== å¤‡ç”¨æ–¹æ¡ˆï¼šä» Notion API è·å– A é¡µé¢å…³è”çš„ B é¡µé¢ ID ==========
def get_related_page_ids_from_notion(page_id):
    url = f"https://api.notion.com/v1/pages/{page_id}"
    resp = requests.get(url, headers=HEADERS)
    if resp.status_code != 200:
        print(f"âŒ è·å– A é¡µé¢å¤±è´¥: {resp.text}")
        return None
    props = resp.json().get("properties", {})
    relation_prop = props.get("Fiarybase", {})
    relation_list = relation_prop.get("relation", [])
    if relation_list:
        related_page_ids = [r["id"] for r in relation_list]
        print(f"âœ… ä» Notion API è·å– `Fiarybase` å…³è”é¡µé¢: {related_page_ids}")
        return related_page_ids
    else:
        print(f"âš ï¸ A é¡µé¢ {page_id} æ²¡æœ‰å…³è”çš„ B é¡µé¢")
        return None

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
